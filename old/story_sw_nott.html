<!DOCTYPE html>
<html>
  <head>
    <title>Snow White Event Chart</title>
    <script type="text/javascript" src="lib/d3.v2.js"></script>
	<link rel="stylesheet" href="../styles/bootstrap.min.css">
	<link rel="stylesheet/less" href="../styles/bootswatch.less">
	<link rel="stylesheet/less" href="../styles/variables.less">
	<link rel="stylesheet/less" href="../styles/less-1.3.0.min.less">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> 
	<script type="text/javascript" src="lib/jquery.tipsy.js"></script>
	<script type="text/javascript" src="data/snow_white.js"></script>
	<link type="text/css" rel="stylesheet" href="stylesheets/force2.css"/>
	<link type="text/css" rel="stylesheet" href="stylesheets/tipsy.css"/>
	<style type="text/css">
	
	//CSS STARTS HERE
	
	
	
	</style>
	</head>
	
	  <body>
	
	
		<div class="storyHeading" id="storyHeading">
		</div>
		<div class="tropeBar" id="tropeBar">
		</div>
		<div class="charBar" id="charBar">
		</div>
	    <script type="text/javascript">
	
		var storyHeading = d3.select("#storyHeading")
			.append("svg:svg")
			.append("svg:g");
			
		storyHeading.append("svg:text")
			.text("Snow White (by Plot Device)")
			.attr("x", 20)
			.attr("y", 20)
			.style("font-size", "24")
			.style("fill", "steelblue");
		
		
		//d3 STARTS HERE
		var w = 1400,
		    h = 600,
		    r = 6,
			times = timepoints;
			nodeX = Math.floor(w/(timepoints.length+1))
			nodeY = Math.floor(h/(timepoints.length+1))
			padX = Math.floor(nodeX/2);
			padY = Math.floor(nodeY/2);
		    fill = d3.scale.category20();
			currentHighlights = [];
			selectedChars = [];
			//sortByTrope = true;
		
		var vis = d3.select("body").append("div")
			//.append("svg:svg")
		    .style("width", w + "px")
		    .style("height", h + "px");
		
		/*vis.append("svg:defs").selectAll("marker")
			.enter().append("svg:marker")
			    .attr("id", String)
			    .attr("viewBox", "0 -5 10 10")
			    .attr("refX", 15)
			    .attr("refY", -1.5)
			    .attr("markerWidth", 6)
			    .attr("markerHeight", 6)
			    .attr("orient", "auto")
			  .append("svg:path")
			    .attr("d", "M0,-5L10,0L0,5");*/

		var force = d3.layout.force()
		    .nodes(nodes)
		    .links(links)
		    .size([w, h])
		    .linkDistance(60)
		    .charge(-300)
		    .on("tick", tick)
		    .start();

	  	var link = vis.selectAll("div.link")
	      	.data(links)
	    	.enter().append("div")
	      	.attr("class", "link") 
			
			/*.append("svg:defs").selectAll("marker")
		    .append("svg:marker")
		    .attr("id", String)
		    .attr("viewBox", "0 -5 10 10")
		    .attr("refX", 15)
		    .attr("refY", -1.5)
		    .attr("markerWidth", 6)
		    .attr("markerHeight", 6)
		    .attr("orient", "auto")
		  .append("svg:path")
		    .attr("d", "M0,-5L10,0L0,5")*/;
		
	
			var	stats = determineDistTropes();
			var	tropesList = stats[0];
			var	tropesIncidence = stats[1];
			var	nodesList = stats[2];
			var	tots = stats[3];
			
			var i=0;
			nodevals = [];
			for(i=0;i<events.length;i++)
			{
				//nodevals[i] = [tropesList.length+5];
				//nodevals[i] = tropesList.length+1;
				nodevals[i] = 0;
			}
				var j = 0;
				for(j=0;j<nodesList.length;j++)
				{
					var k=0;
					for(k=0;k<nodesList[j].length;k++)
					{
						//console.log("nodeslist here is" + nodesList[j][k]);
						nodevals[nodesList[j][k]]=j+1;
						//console.log("we have recorded the value "+nodevals[nodesList[j][k]]);
					}
				}
				
				//console.log(nodevals);

			
	  	var node = vis.selectAll("div.node")
	      	.data(nodes)
	    	.enter().append("div")
	      	.attr("class", "node")
	      	.style("background", function(d) {
		 		//console.log("d.id "+d.id)
				//console.log("nodevals[d.id] "+nodevals[d.id])
				if(nodevals[d.id]==0)
				{return "lightgrey"}
				else   
				{return fill(nodevals[d.id])}; 
				})
	      	/*.style("border-color", function(d) { 
				return d3.rgb(fill(d.group)).darker(); 
				})*/
			.style("opacity", .9)
			.call(force.drag);
			
			
			

	      	

	  force
	      	//.nodes(nodes)
	      	//.links(links)
	      	.on("tick", tick)
	      	.start();
			
			node.append("text")
				      .attr("dx", function(d) { return d.x < 180 ? 20 : -20; })
				      .attr("dy", ".41em")
				      .attr("text-anchor", function(d) { return d.x < 180 ? 100 : "end"; })
				      .attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })
				      .text(function(d) { return d.name; });

	  $('.node').tipsy({ 
		        gravity: 'w', 
		        html: true, 
		        title: function(d) { d= this.__data__; //console.log(d);
		          return d.name; 
		        }
		      });
		
			node.style("border-style", "solid")
			.style("border-width", "2px")
			.style("border-color", function(d) { if(selectedChars.length===0)
				{return "transparent" /*d3.rgb(fill(d.group)).darker()*/;}
				else
				{
					if(selectedChars[d.id]===true)
					{
						return "black";
					}
					else
					{
						return "transparent";
					}
				}
				})

	  

	  function transform(d) {
	    return "rotate(" + Math.atan2(d.target.y - d.source.y, d.target.x - d.source.x) * 180 / Math.PI + "deg)";
	  }

	  function length(d) {
	    var dx = d.target.x - d.source.x,
	        dy = d.target.y - d.source.y;
	    return Math.sqrt(dx * dx + dy * dy) + "px";
	  }
	
	  
	
	function tick() {
	    /*node.style("left",  function(d) { return (d.x = Math.max(r, nodeX*d.value+20 )) + "px"; })
	        .style("top", function(d) { return (d.y = Math.max(r, Math.min(h - r, d.y))) + "px";
 });*/
		//var yvals = sortByTrope(h);
		node.style("left", function(d) { return (d.x = Math.max(r, nodeX*d.time+padX )) + "px"; })
			
		    //.style("top", function(d) { return (d.y = Math.max(r, yvals[0][d.id])) + "px"; });
			.style("top", function(d) { return (d.y = Math.max(r, Math.min(h - r, d.y))) + "px";
 });


	    link.style("left", function(d) { return d.source.x + "px"; })
	        .style("top", function(d) { return d.source.y + "px"; })
	        .style("width", length)
	        .style("-webkit-transform", transform)
	        .style("-moz-transform", transform)
	        .style("-ms-transform", transform)
	        .style("-o-transform", transform)
	        .style("transform", transform);
	  }

/////////// T BARS

var i=0;
var foo = [];
for(i=0;i<tropesList.length;i++)
{
	foo.push[i];
}

var dataB = tropesIncidence;
var mortdataB = foo;
//mortData = findMortData(5,15);

var tBarW = 170,
    tBarH = 120,
    agex = d3.scale.linear().domain([0, 5]).range([0, tBarW]),
    agey = d3.scale.ordinal().domain(d3.range(dataB.length)).rangeBands([0, tBarH]);
	size = 600;
	padding = 20;
	fill = d3.scale.category20();
	

var tropeBar = d3.select("#tropeBar")
	.append("svg:svg")
	    .attr("width", tBarW + 40) //add padding for axis labels
	    .attr("height", tBarH + 20)
	  .append("svg:g")
	    .attr("transform", "translate(20,0)");
	tropeBar.append("svg:text")
	  .attr("class", "title")
	  .attr("y", 10 )
	  //.attr("dy", ".71em")
	  //.attr("transform", function(d) {return "translate(" + ((d % numPerRow) * (mainPanelW + margin)) + "," + (Math.floor(d/numPerRow) * (mainPanelH + margin) + textOffset) + ")";})
	  .text("Plot Devices");

var tBars = tropeBar.selectAll("g.bar")
    .data(dataB)
  .enter().append("svg:g").attr("class", "bar");
    //.attr("class", "oneBar")
    //.attr("transform", function(d, i) { return "translate(0," + agey(i) + ")"; });


tBars.append("svg:rect")
    .attr("x", 0)
    .attr("y", function(d,i) { return agey(i)+15; })
    .attr("width", agex)
    .attr("height", agey.rangeBand())
	.style("fill", function(d,i){ 
	//console.log("fill bar "+fill(i))
	return fill(i)
	});
	
	/*.on("mouseout", function(d,i) {
		if(!mouseIsDown)
			d3.select(this).style("border-color", function(d,i){ 
				return "black"
				});
		//DM: didn't see this function doing anything
		//highlight(-1);
	})*/


	/*.on("mouseover", function(d,i) {
		d3.select(this).style("fill", "blue");
		if(mouseIsDown){
			if(maxRange < d.index)
				maxRange = d.index;
			if(minRange > d.index)
				minRange = d.index;
		};*/


tBars.append("svg:text")
	.attr("transform","translate(25,0)")
    .attr("x", agex)
    //.attr("y", agey.rangeBand() / 2)
	.attr("y",function(d,i) { return 15+ agey(i)+ agey.rangeBand()/2;})
    .attr("dx", -20)
    .attr("dy", ".35em")
    .attr("fill", "black")
    .attr("text-anchor", "front")
    .text(function(d,i) { return tropesList[i]; });

	tBars.append("svg:text")
		.attr("transform","translate(25,0)")
	    .attr("x", agex)
	    //.attr("y", agey.rangeBand() / 2)
		.attr("y",function(d,i) { return 15+ agey(i)+ agey.rangeBand()/2;})
	    .attr("dx", -40)
	    .attr("dy", ".35em")
	    .attr("fill", "white")
	    .attr("text-anchor", "front")
	    .text(function(d,i) { return tropesIncidence[i]; });

///////////////Character bars	
var i=0;
var foo = [];
for(i=0;i<characters.length;i++)
{
	foo.push[characters[i].name];
	console.log(foo);
}

console.log(foo);

var dataB = totalChars();
var mortdataB = foo;
//mortData = findMortData(5,15);

var cBarW = 250,
    cBarH = 150,
    charx = d3.scale.linear().domain([0, 35]).range([0, cBarW]),
    chary = d3.scale.ordinal().domain(d3.range(dataB.length)).rangeBands([0, cBarH]);
	size = 300;
	padding = 20;
	fill = d3.scale.category20c();
	

var charBar = d3.select("#charBar")
	.append("svg:svg")
	    .attr("width", cBarW + 40) //add padding for axis labels
	    .attr("height", cBarH + 20)
	  .append("svg:g")
	    .attr("transform", "translate(20,0)");
	charBar.append("svg:text")
	  .attr("class", "title")
	  .attr("y", 10 )
	  //.attr("dy", ".71em")
	  //.attr("transform", function(d) {return "translate(" + ((d % numPerRow) * (mainPanelW + margin)) + "," + (Math.floor(d/numPerRow) * (mainPanelH + margin) + textOffset) + ")";})
	  .text("Characters");

var cBars = charBar.selectAll("g.bar")
    .data(dataB)
  .enter().append("svg:g").attr("class", "bar");
    //.attr("class", "oneBar")
    //.attr("transform", function(d, i) { return "translate(0," + chary(i) + ")"; });


cBars.append("svg:rect")
    .attr("x", 0)
    .attr("y", function(d,i) { return chary(i)+15; })
    .attr("width", charx)
    .attr("height", chary.rangeBand())
	.style("fill", function(d,i){ 
	//console.log("fill bar "+fill(i))
	return fill(i)
	})
	.style("opacity", .7)
	
	.on("mouseout", function(d,i) {
		d3.select(this).style("opacity", .7);
		selectedChars = tfChars(" ");
		//console.log(selectedChars);
	 	}
		//DM: didn't see this function doing anything
		//highlight(-1);
	)


	.on("mouseover", function(d,i) {
		d3.select(this).style("opacity", 1);
		var chartf = tfChars(characters[i].name);
		selectedChars = tfChars(d.name);
		console.log(selectedChars);
		/*if(mouseIsDown){
			if(maxRange < d.index)
				maxRange = d.index;
			if(minRange > d.index)
				minRange = d.index;
		};*/});


cBars.append("svg:text")
	.attr("transform","translate(25,0)")
    .attr("x", charx)
    //.attr("y", chary.rangeBand() / 2)
	.attr("y",function(d,i) { return 15+ chary(i)+ chary.rangeBand()/2;})
    .attr("dx", -20)
    .attr("dy", ".35em")
    .attr("fill", "black")
    .attr("text-anchor", "front")
    .text(function(d,i) { return characters[i].name; });

	cBars.append("svg:text")
		.attr("transform","translate(25,0)")
	    .attr("x", charx)
	    //.attr("y", chary.rangeBand() / 2)
		.attr("y",function(d,i) { return 15+ chary(i)+ chary.rangeBand()/2;})
	    .attr("dx", -37)
	    .attr("dy", ".35em")
	    .attr("fill", "white")
	    .attr("text-anchor", "front")
	    .text(function(d,i) { return dataB[i]; });

	
///////////////GRID LINES

		// Select the DIV container "D3line" then
		// add an SVG element to it

		var width = w;
		var height = h-100;

		var lineGraph = d3.select("div")
		    .append("svg:svg")
		    .attr("width", width)    
		    .attr("height", height); 

		// To draw a line use the "svg:line" element.
		// "svg:line" element requires 4 attributes (x1, y1, x2, and y2)
		// (x1,y1) are coordinates of the starting point. 
		// (x2,y2) are coordinates of the end point.
		// You also need to specify the stroke color.

		// Using for loop to draw multiple horizontal lines
		/*for (var j=25; j <= width-25; j=j+25) {
		    lineGraph.append("svg:line")
		        .attr("x1", 25)
		        .attr("y1", j)
		        .attr("x2", width-25)
		        .attr("y2", j)
		        .style("stroke", "rgb(6,120,155)")
		        .style("stroke-width", 2);            
		};*/

		// Using for loop to draw multiple vertical lines
		for (var j=padX+35; j <= events.length*(nodeX-2)-padY; j=j+nodeX) {
		    lineGraph.append("svg:line")
		        .attr("x1", j)
		        .attr("y1", 25)
		        .attr("x2", j)
		        .attr("y2", height-25)
		        .style("stroke", "rgb(6,120,155)")
		        .style("stroke-width", .2);            
		};
		
///////////// Collect all items that contain a certain character

		
		</script>
	  </body>
</html>