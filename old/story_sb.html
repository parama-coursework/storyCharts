<!DOCTYPE html>
<html>
  <head>
    <title>Force-Directed Layout</title>
    <script type="text/javascript" src="lib/d3.v2.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> 
	<script type="text/javascript" src="lib/jquery.tipsy.js"></script>
	<script type="text/javascript" src="data/sleeping_beauty.js"></script>
	<link type="text/css" rel="stylesheet" href="stylesheets/force.css"/>
	<link type="text/css" rel="stylesheet" href="stylesheets/tipsy.css"/>
	<style type="text/css">
	
	//CSS STARTS HERE
	
	
	
	</style>
	</head>
	  <body>
		<div class="storyHeading" id="storyHeading">
		</div>
		<div class="tropeBar" id="tropeBar">
		</div>
	    <script type="text/javascript">
	
		var storyHeading = d3.select("#storyHeading")
			.append("svg:svg")
			.append("svg:g");
			
		storyHeading.append("svg:text")
			.text("Sleeping Beauty")
			.attr("x", 20)
			.attr("y", 20)
			.style("font-size", "24")
			.style("fill", "steelblue");
		
		
		//d3 STARTS HERE
		var w = 600,
		    h = 450,
		    r = 6,
			times = timepoints;
			nodeX = Math.floor(w/(timepoints.length+1))
			nodeY = Math.floor(h/(timepoints.length+1))
			padX = Math.floor(nodeX/2);
			padY = Math.floor(nodeY/2);
		    fill = d3.scale.category20();
			//sortByTrope = true;
		
		var vis = d3.select("body").append("div")
		    .style("width", w + "px")
		    .style("height", h + "px");

		var force = d3.layout.force()
		    .nodes(nodes)
		    .links(links)
		    .size([w, h])
		    .linkDistance(60)
		    .charge(-300)
		    .on("tick", tick)
		    .start();

	  	var link = vis.selectAll("div.link")
	      	.data(links)
	    	.enter().append("div")
	      	.attr("class", "link");
	
			var	stats = determineDistTropes();
			var	tropesList = stats[0];
			var	tropesIncidence = stats[1];
			var	nodesList = stats[2];
			var	tots = stats[3];
			
			var i=0;
			nodevals = [];
			for(i=0;i<events.length;i++)
			{
				nodevals[i] = [tropesList.length];
			}
				var j = 0;
				for(j=0;j<nodesList.length;j++)
				{
					var k=0;
					for(k=0;k<nodesList[j].length;k++)
					{
						nodevals[nodesList[j][k]]=k;
					}
				}

			

	  	var node = vis.selectAll("div.node")
	      	.data(nodes)
	    	.enter().append("div")
	      	.attr("class", "node")
	      	.style("background", function(d) { 
				return fill(nodevals[d.id]); 
				})
	      	.style("border-color", function(d) { 
				return d3.rgb(fill(d.group)).darker(); 
				})
		  	//.attr("r", 20)
		  	/*.attr("y",  function(d){
			Math.floor((nodeY*d.value+20)*Math.random());
			})*/
			
			.call(force.drag);
			

	      	

	  force
	      	//.nodes(nodes)
	      	//.links(links)
	      	.on("tick", tick)
	      	.start();

	  $('.node').tipsy({ 
		        gravity: 'w', 
		        html: true, 
		        title: function(d) { d= this.__data__; console.log(d);
		          return d.name; 
		        }
		      });

	  

	  function transform(d) {
	    return "rotate(" + Math.atan2(d.target.y - d.source.y, d.target.x - d.source.x) * 180 / Math.PI + "deg)";
	  }

	  function length(d) {
	    var dx = d.target.x - d.source.x,
	        dy = d.target.y - d.source.y;
	    return Math.sqrt(dx * dx + dy * dy) + "px";
	  }
	
	  
	
	function tick() {
	    /*node.style("left",  function(d) { return (d.x = Math.max(r, nodeX*d.value+20 )) + "px"; })
	        .style("top", function(d) { return (d.y = Math.max(r, Math.min(h - r, d.y))) + "px";
 });*/
		//var yvals = sortByTrope(h);
		node.style("left", function(d) { return (d.x = Math.max(r, nodeX*d.time+padX )) + "px"; })
		    //.style("top", function(d) { return (d.y = Math.max(r, yvals[0][d.id])) + "px"; });
			.style("top", function(d) { return (d.y = Math.max(r, Math.min(h - r, d.y))) + "px";
 });


	    link.style("left", function(d) { return d.source.x + "px"; })
	        .style("top", function(d) { return d.source.y + "px"; })
	        .style("width", length)
	        .style("-webkit-transform", transform)
	        .style("-moz-transform", transform)
	        .style("-ms-transform", transform)
	        .style("-o-transform", transform)
	        .style("transform", transform);
	  }
/////////////////////////////////////////


var i=0;
var foo = [];
for(i=0;i<tropesList.length;i++)
{
	foo.push[i];
}

var dataA = tropesIncidence;
var mortDataA = foo;
//mortData = findMortData(5,15);

var tBarW = 200,
    tBarH = 200,
    agex = d3.scale.linear().domain([0, 5]).range([0, tBarW]),
    agey = d3.scale.ordinal().domain(d3.range(dataA.length)).rangeBands([0, tBarH]);
	size = 600;
	padding = 20;
	fill = d3.scale.category20();
	




var tropeBar = d3.select("#tropeBar")
	.append("svg:svg")
	    .attr("width", tBarW + 40) //add padding for axis labels
	    .attr("height", tBarH + 20)
	  .append("svg:g")
	    .attr("transform", "translate(20,0)");
	tropeBar.append("svg:text")
	  .attr("class", "title")
	  .attr("y", 10 )
	  //.attr("dy", ".71em")
	  //.attr("transform", function(d) {return "translate(" + ((d % numPerRow) * (mainPanelW + margin)) + "," + (Math.floor(d/numPerRow) * (mainPanelH + margin) + textOffset) + ")";})
	  .text("Tropes");

var tBars = tropeBar.selectAll("g.bar")
    .data(dataA)
  .enter().append("svg:g").attr("class", "bar");
    //.attr("class", "oneBar")
    //.attr("transform", function(d, i) { return "translate(0," + agey(i) + ")"; });

tBars.append("svg:rect")
    .attr("x", 0)
    .attr("y", function(d,i) { return agey(i)+15; })
    .attr("width", agex)
    .attr("height", agey.rangeBand())
	.style("fill", function(d,i){ 
	return fill(i)
	});
	
	/*.on("mouseout", function(d,i) {
		if(!mouseIsDown)
			d3.select(this).style("border-color", function(d,i){ 
				return "black"
				});
		//DM: didn't see this function doing anything
		//highlight(-1);
	})*/


	/*.on("mouseover", function(d,i) {
		d3.select(this).style("fill", "blue");
		if(mouseIsDown){
			if(maxRange < d.index)
				maxRange = d.index;
			if(minRange > d.index)
				minRange = d.index;
		};*/

tBars.append("svg:text")
	.attr("transform","translate(25,0)")
    .attr("x", agex)
    //.attr("y", agey.rangeBand() / 2)
	.attr("y",function(d,i) { return 15+ agey(i)+ agey.rangeBand()/2;})
    .attr("dx", -20)
    .attr("dy", ".35em")
    .attr("fill", "black")
    .attr("text-anchor", "front")
    .text(function(d,i) { return tropesList[i]; });
		
		</script>
	  </body>
</html>